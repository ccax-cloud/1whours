<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10,000 Hours Journey</title>
    <link id="dynamic-favicon" rel="icon" href="">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --bg-main: #050505; --bg-pattern: #1a1a1a; --container-bg: #0d0d0d; --text-primary: #33ff33; --text-secondary: #e0e0e0; --bar-empty: #222; --border-color: #000; --accent-red: #ff0000; --btn-hover-bg: #222; }
        .day-mode { --bg-main: #e0e0e0; --bg-pattern: #d0d0d0; --container-bg: #f0f0f0; --text-primary: #228b22; --text-secondary: #222; --bar-empty: #cccccc; --border-color: #444; --accent-red: #cc0000; --btn-hover-bg: #e0e0e0; }
        
        body { 
            background-color: var(--bg-main); 
            background-image: radial-gradient(var(--bg-pattern) 1px, transparent 1px); 
            background-size: 20px 20px; 
            color: var(--text-secondary); 
            font-family: 'VT323', monospace; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
            overflow: hidden; 
            transition: all 0.5s steps(4); 
        }

        @media (max-width: 768px) {
            body { 
                justify-content: flex-start; 
                height: auto; 
                min-height: 100dvh; 
                padding-top: 100px; 
                padding-bottom: 40px;
                box-sizing: border-box;
                overflow-y: auto; 
            }
        }

        @media (max-height: 500px) and (orientation: landscape) {
            body { padding-top: 20px; justify-content: flex-start; }
            .player-card { transform: scale(0.65); transform-origin: top center; margin-bottom: -120px; }
            #quote-container { transform: scale(0.8); margin-top: 0; }
        }

        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .player-card { width: 500px; max-width: 90%; position: relative; z-index: 10; perspective: 1000px; }
        .card-inner { position: relative; width: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-face { background: var(--container-bg); padding: 30px; border: 4px solid var(--border-color); box-shadow: 8px 8px 0px var(--border-color); width: 100%; box-sizing: border-box; backface-visibility: hidden; position: relative; }
        .card-back { position: absolute; top: 0; left: 0; height: 100%; width: 100%; transform: rotateY(180deg); display: flex; flex-direction: column; justify-content: center; }
        
        .orbit-container { position: absolute; top: 25px; right: 25px; width: 48px; height: 48px; z-index: 100; }
        #celestial-body { width: 48px; height: 48px; cursor: pointer; image-rendering: pixelated; }
        #celestial-body svg { width: 100%; height: 100%; }

        .time-box { position: relative; text-align: center; margin-bottom: 10px; display: inline-flex; align-items: center; justify-content: center; width: 100%; }
        .edit-trigger { position: absolute; left: calc(50% + 115px); top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0; cursor: pointer; transition: opacity 0.2s; background: var(--text-primary); color: #000; padding: 2px 6px; font-weight: bold; }
        .time-box:hover .edit-trigger { opacity: 1; }
        @media (max-width: 600px) { .edit-trigger { opacity: 0.5; left: auto; right: 0; } }

        .time-display { font-size: 3.2rem; color: var(--text-primary); text-shadow: 2px 2px 0px var(--border-color); line-height: 1; letter-spacing: 1px; }
        .progress-container { height: 14px; background: var(--bar-empty); border: 3px solid var(--border-color); margin: 5px 0 15px 0; }
        .bar-fill { height: 100%; width: 0%; background: #888; transition: width 0.3s; }
        .info-label { font-size: 1.1rem; opacity: 0.7; letter-spacing: 1px; display: flex; justify-content: space-between; margin-top: 5px; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; }
        button { background: var(--bar-empty); border: 3px solid var(--border-color); color: var(--text-secondary); padding: 12px 0; font-family: 'VT323', monospace; font-size: 1.4rem; cursor: pointer; box-shadow: 4px 4px 0px var(--border-color); transition: background 0.2s ease; z-index: 20; }
        button:hover { background: var(--btn-hover-bg); }
        #reset-btn { background: var(--accent-red); color: white; }

        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 4px; background: rgba(0,0,0,0.3); padding: 10px; border: 2px solid var(--border-color); }
        .heat-cell { width: 100%; aspect-ratio: 1/1; background: var(--bar-empty); }

        #quote-container { margin-top: 40px; max-width: 600px; text-align: center; min-height: 60px; z-index: 10; padding: 0 20px; cursor: pointer; }
        .quote-text { font-size: 1.6rem; color: var(--text-secondary); opacity: 0; transition: all 0.3s; line-height: 1.4; }
    </style>
</head>
<body class="day-mode">
<canvas id="fireworks-canvas"></canvas>
<div class="player-card" id="card-root">
    <div class="card-inner">
        <div class="card-face">
            <div id="trigger-flip-front" style="position:absolute; right:0; top:20%; width:40px; height:60%; cursor:pointer; z-index:100;" onclick="toggleFlip()" onmouseenter="showTip('VIEW HEATMAP >>')" onmouseleave="hideTip()"></div>
            <div class="orbit-container"><div id="celestial-body" title="Switch Mode"></div></div>
            <div class="info-label">TOTAL JOURNEY</div>
            <div class="time-box"><span class="time-display" id="total-time">0000:00:00</span><div class="edit-trigger" id="edit-total">EDIT</div></div>
            <div class="info-label">TODAY'S RECORD</div>
            <div class="time-box"><span class="time-display" id="today-time" style="font-size: 2.2rem;">00:00</span><div class="edit-trigger" id="edit-today">EDIT</div></div>
            <div class="info-label"><span>YEAR PROGRESS</span><span id="year-stats">0/365 DAYS (0%)</span></div>
            <div class="progress-container"><div id="year-bar" class="bar-fill"></div></div>
            <div class="controls"><button id="start-btn">PLAY</button><button id="pause-btn">PAUSE</button><button id="reset-btn">RESET</button></div>
        </div>
        <div class="card-face card-back">
            <div id="trigger-flip-back" style="position:absolute; left:0; top:20%; width:40px; height:60%; cursor:pointer; z-index:100;" onclick="toggleFlip()"></div>
            <div class="info-label" style="margin-bottom:15px;">FOCUS HEATMAP (LAST 100 DAYS)</div>
            <div id="heatmap" class="heatmap-grid"></div>
            <div class="info-label" style="margin-top: 20px; font-size: 0.9rem;">* CLICK TEXT BELOW TO CHANGE KEYWORD</div>
        </div>
    </div>
</div>
<div id="quote-container" onclick="setFocusKeyword()"><div id="quote-content" class="quote-text">Syncing...</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SB_URL = "https://rattzrovuipztscogenj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhdHR6cm92dWlwenRzY29nZW5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjEyNTgsImV4cCI6MjA4NTkzNzI1OH0.zfMIL_hnFzTXnUG_HdN-NtjJWbmrvmpdJy-OeCiqiOI";
    const YT_API_KEY = "AIzaSyCRqth-MrjfAjhDsdTPP-CPw-xn93oJWAY"; 
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let totalSeconds = 0, todaySeconds = 0, historyData = {}, isDayMode = localStorage.getItem('px_mode') !== 'night', isRunning = false, timerInterval, lastQuoteText = "", isFlipping = false;
    let focusKeyword = localStorage.getItem('focus_keyword') || "study with me";

    const getTodayKey = () => new Date().toISOString().split('T')[0];

    async function getLiveLearnersCount() {
        try {
            const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&eventType=live&type=video&q=${encodeURIComponent(focusKeyword)}&maxResults=5&key=${YT_API_KEY}`;
            const res = await fetch(searchUrl);
            const data = await res.json();
            if (!data.items || data.items.length === 0) return null;
            const videoIds = data.items.map(i => i.id.videoId).join(',');
            const statsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoIds}&key=${YT_API_KEY}`);
            const statsData = await statsRes.json();
            let total = 0;
            statsData.items?.forEach(i => { total += parseInt(i.liveStreamingDetails?.concurrentViewers || 0); });
            return total > 0 ? total : null;
        } catch (e) { return null; }
    }

    async function updateQuote(force = false) {
        const c = document.getElementById('quote-content');
        if (force || lastQuoteText === "") {
            const count = await getLiveLearnersCount();
            if (count) {
                lastQuoteText = `${count.toLocaleString()} souls are in the ${focusKeyword} flow.`;
            } else {
                lastQuoteText = `Keep pushing in your ${focusKeyword} journey. `;
            }
        }
        // 始终优先显示直播人数句子
        c.innerText = lastQuoteText;
        c.style.color = 'var(--text-secondary)';
        c.style.opacity = 1;
    }

    function toggleFlip() {
        if (isFlipping) return;
        isFlipping = true;
        const card = document.getElementById('card-root');
        card.classList.toggle('is-flipped');
        
        setTimeout(() => { 
            if(card.classList.contains('is-flipped')) {
                initHeatmap();
            }
            // 翻转完成后确保文字恢复为直播人数
            updateQuote(); 
            isFlipping = false; 
        }, 650);
    }

    function showTip(text) {
        // 仅在正面时生效
        if (document.getElementById('card-root').classList.contains('is-flipped')) return;
        const c = document.getElementById('quote-content');
        c.innerText = text; 
        c.style.color = 'var(--text-primary)';
    }

    function hideTip() { 
        // 恢复成直播人数句子
        const c = document.getElementById('quote-content');
        c.innerText = lastQuoteText;
        c.style.color = 'var(--text-secondary)';
    }

    function setFocusKeyword() {
        let input = prompt("What are you focusing on?", focusKeyword);
        if (input !== null && input.trim() !== "") {
            focusKeyword = input.trim();
            localStorage.setItem('focus_keyword', focusKeyword);
            updateQuote(true);
        }
    }

    function initHeatmap() {
        const h = document.getElementById('heatmap'); h.innerHTML = '';
        const now = new Date();
        for (let i = 99; i >= 0; i--) {
            const d = new Date(); d.setDate(now.getDate() - i);
            const key = d.toISOString().split('T')[0];
            const hrs = (historyData[key] || 0) / 3600;
            const cell = document.createElement('div');
            cell.className = 'heat-cell';
            if (hrs > 0) cell.style.background = `rgba(${isDayMode?'34,139,34':'51,255,51'}, ${Math.min(0.2+hrs/5, 1)})`;
            h.appendChild(cell);
        }
    }

    function updateUI(shouldSync = true) {
        document.getElementById('total-time').innerText = formatTime(totalSeconds);
        document.getElementById('today-time').innerText = formatTime(todaySeconds).substring(5);
        const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        document.getElementById('year-stats').innerText = `${dayOfYear}/365 DAYS (${(dayOfYear/3.65).toFixed(2)}%)`;
        document.getElementById('year-bar').style.width = (dayOfYear/3.65) + '%';
        historyData[getTodayKey()] = todaySeconds;
        if (shouldSync) syncToCloud();
    }

    function formatTime(s) { 
        const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sc=s%60;
        return `${h.toString().padStart(4,'0')}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
    }

    document.getElementById('start-btn').onclick = () => { if(!isRunning){ isRunning=true; timerInterval=setInterval(()=>{totalSeconds++; todaySeconds++; updateUI(false);},1000); }};
    document.getElementById('pause-btn').onclick = () => { isRunning=false; clearInterval(timerInterval); syncToCloud(); };
    document.getElementById('reset-btn').onclick = () => { if(confirm("Reset?")){ totalSeconds=0; todaySeconds=0; updateUI(); }};
    document.getElementById('edit-total').onclick = () => { let v=prompt("Total Hours:", (totalSeconds/3600).toFixed(2)); if(v){totalSeconds=parseFloat(v)*3600; updateUI();}};
    document.getElementById('edit-today').onclick = () => { let v=prompt("Today Hours:", (todaySeconds/3600).toFixed(2)); if(v){todaySeconds=parseFloat(v)*3600; updateUI();}};
    document.getElementById('celestial-body').onclick = () => { isDayMode=!isDayMode; renderTheme(); };

    async function syncToCloud() { await _supabase.from('records').upsert({ id: 1, data: { totalSeconds, todaySeconds, historyData }}); }
    async function loadFromCloud() { 
        const { data } = await _supabase.from('records').select('data').eq('id', 1).single();
        if (data?.data) { 
            totalSeconds = data.data.totalSeconds || 0; 
            todaySeconds = data.data.todaySeconds || 0; 
            historyData = data.data.historyData || {}; 
            updateUI(false); 
        } 
    }

    function renderTheme() {
        document.body.className = isDayMode ? 'day-mode' : '';
        document.getElementById('celestial-body').innerHTML = isDayMode ? sunIcon : moonIcon;
    }

    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect x="5" y="1" width="6" height="14" fill="#FFD700"/><rect x="3" y="2" width="10" height="12" fill="#FFD700"/><rect x="2" y="3" width="12" height="10" fill="#FFD700"/><rect x="1" y="5" width="14" height="6" fill="#FFD700"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect x="5" y="1" width="6" height="14" fill="#E0E0E0"/><rect x="3" y="2" width="10" height="12" fill="#E0E0E0"/><rect x="2" y="3" width="12" height="10" fill="#E0E0E0"/><rect x="1" y="5" width="14" height="6" fill="#E0E0E0"/><circle cx="5" cy="6" r="1.5" fill="#BDBDBD"/><circle cx="11" cy="5" r="1.2" fill="#BDBDBD"/><circle cx="8" cy="11" r="1.8" fill="#BDBDBD"/></svg>`;

    (async () => { 
        renderTheme(); 
        await loadFromCloud(); 
        updateQuote(true); 
        setInterval(() => updateQuote(true), 60000); 
    })();

    const canvas = document.getElementById('fireworks-canvas'), ctx = canvas.getContext('2d');
    let particles = [];
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    window.dispatchEvent(new Event('resize'));
    function animate() { ctx.clearRect(0,0,canvas.width,canvas.height); particles = particles.filter(p => p.alpha > 0); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
    animate();

    class Particle { constructor(x, y, color) { this.x = x; this.y = y; this.color = color; this.vx = (Math.random()-0.5)*15; this.vy = (Math.random()-0.5)*15; this.alpha = 1; } update() { this.x += this.vx; this.y += this.vy; this.vy += 0.25; this.alpha -= 0.015; } draw() { ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 4, 4); } }
    function launchCelebration(x, y) { const colors = isDayMode ? ['#228b22', '#ff4500', '#ffd700', '#1e90ff'] : ['#33ff33', '#ffffff', '#ffeb3b', '#ff4081']; for(let i=0; i<60; i++) particles.push(new Particle(x, y, colors[Math.floor(Math.random()*colors.length)])); }
    window.addEventListener('mousedown', (e) => {
        const forbiddenTags = ['BUTTON', 'INPUT', 'TEXTAREA'];
        if (forbiddenTags.includes(e.target.tagName) || e.target.classList.contains('edit-trigger') || e.target.closest('#quote-container')) return;
        const rect = document.getElementById('card-root').getBoundingClientRect();
        if (!(e.clientX >= rect.left && e.clientX <= rect.right && e.clientY >= rect.top && e.clientY <= rect.bottom)) launchCelebration(e.clientX, e.clientY);
    });
</script>
</body>
</html>
