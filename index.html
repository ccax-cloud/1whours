<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>10,000 Hours Journey</title>
    <link id="dynamic-favicon" rel="icon" href="">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        :root { --bg-main: #050505; --bg-pattern: #1a1a1a; --container-bg: #0d0d0d; --text-primary: #33ff33; --text-secondary: #e0e0e0; --bar-empty: #222; --border-color: #000; --accent-red: #ff0000; --btn-hover-bg: #33ff33; --btn-hover-text: #000; }
        .day-mode { --bg-main: #e0e0e0; --bg-pattern: #d0d0d0; --container-bg: #f0f0f0; --text-primary: #228b22; --text-secondary: #222; --bar-empty: #cccccc; --border-color: #444; --accent-red: #cc0000; --btn-hover-bg: #228b22; --btn-hover-text: #fff; }
        
        body { background-color: var(--bg-main); background-image: radial-gradient(var(--bg-pattern) 1px, transparent 1px); background-size: 20px 20px; color: var(--text-secondary); font-family: 'VT323', monospace; display: flex; flex-direction: column; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; transition: all 0.5s steps(4); }

        @media (max-width: 768px) {
            body { justify-content: flex-start; height: auto; min-height: 100dvh; padding-top: 100px; padding-bottom: 40px; box-sizing: border-box; overflow-y: auto; }
        }

        #fireworks-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 5; pointer-events: none; }
        .player-card { width: 500px; max-width: 90%; position: relative; z-index: 10; perspective: 1000px; }
        .card-inner { position: relative; width: 100%; transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1); transform-style: preserve-3d; }
        .is-flipped .card-inner { transform: rotateY(180deg); }
        .card-face { background: var(--container-bg); padding: 30px; border: 4px solid var(--border-color); box-shadow: 8px 8px 0px var(--border-color); width: 100%; box-sizing: border-box; backface-visibility: hidden; position: relative; }
        .card-back { position: absolute; top: 0; left: 0; height: 100%; width: 100%; transform: rotateY(180deg); display: flex; flex-direction: column; justify-content: center; }
        
        .orbit-container { position: absolute; top: 25px; right: 25px; width: 48px; height: 48px; z-index: 100; }
        #celestial-body { width: 48px; height: 48px; cursor: pointer; image-rendering: pixelated; }

        .time-box { position: relative; text-align: center; margin-bottom: 10px; display: inline-flex; align-items: center; justify-content: center; width: 100%; cursor: pointer; }
        .edit-trigger { position: absolute; left: calc(50% + 115px); top: 50%; transform: translateY(-50%); font-size: 0.8rem; opacity: 0; background: var(--text-primary); color: #000; padding: 2px 6px; font-weight: bold; z-index: 110; transition: opacity 0.2s; pointer-events: none; }

        @media (hover: hover) {
            .time-box:hover .edit-trigger { opacity: 1; }
            button:hover { background: var(--btn-hover-bg) !important; color: var(--btn-hover-text) !important; }
        }

        @media (max-width: 768px) {
            .edit-trigger { display: none !important; }
        }

        .time-display { font-size: 3.2rem; color: var(--text-primary); text-shadow: 2px 2px 0px var(--border-color); line-height: 1; letter-spacing: 1px; pointer-events: none; }
        .progress-container { height: 14px; background: var(--bar-empty); border: 3px solid var(--border-color); margin: 5px 0 15px 0; }
        .bar-fill { height: 100%; width: 0%; background: #888; transition: width 0.3s; }
        .info-label { font-size: 1.1rem; opacity: 0.7; letter-spacing: 1px; display: flex; justify-content: space-between; margin-top: 5px; }
        
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-top: 15px; }
        button { background: var(--bar-empty); border: 3px solid var(--border-color); color: var(--text-secondary); padding: 12px 0; font-family: 'VT323', monospace; font-size: 1.4rem; cursor: pointer; box-shadow: 4px 4px 0px var(--border-color); transition: all 0.2s ease; z-index: 20; }
        #reset-btn:hover { background: #ff4444 !important; color: white !important; }

        .heatmap-grid { display: grid; grid-template-columns: repeat(20, 1fr); gap: 4px; background: rgba(0,0,0,0.3); padding: 10px; border: 2px solid var(--border-color); }
        .heat-cell { width: 100%; aspect-ratio: 1/1; background: var(--bar-empty); }

        #quote-container { margin-top: 40px; max-width: 600px; text-align: center; min-height: 60px; z-index: 10; padding: 0 20px; cursor: pointer; }
        .quote-text { font-size: 1.6rem; color: var(--text-secondary); opacity: 0; transition: all 0.3s; line-height: 1.4; }
    </style>
</head>
<body class="day-mode">
<canvas id="fireworks-canvas"></canvas>
<div class="player-card" id="card-root">
    <div class="card-inner">
        <div class="card-face">
            <div id="trigger-flip-front" style="position:absolute; right:0; top:20%; width:40px; height:60%; cursor:pointer; z-index:100;" onclick="toggleFlip()" onmouseenter="showTip('VIEW HEATMAP >>')" onmouseleave="hideTip()"></div>
            <div class="orbit-container"><div id="celestial-body" title="Switch Mode"></div></div>
            <div class="info-label">TOTAL JOURNEY</div>
            <div class="time-box" id="box-total">
                <span class="time-display" id="total-time">0000:00:00</span>
                <div class="edit-trigger">EDIT</div>
            </div>
            <div class="info-label">TODAY'S RECORD</div>
            <div class="time-box" id="box-today">
                <span class="time-display" id="today-time" style="font-size: 2.2rem;">00:00</span>
                <div class="edit-trigger">EDIT</div>
            </div>
            <div class="info-label"><span>YEAR PROGRESS</span><span id="year-stats">0/365 DAYS (0%)</span></div>
            <div class="progress-container"><div id="year-bar" class="bar-fill"></div></div>
            <div class="controls"><button id="start-btn">PLAY</button><button id="pause-btn">PAUSE</button><button id="reset-btn">RESET</button></div>
        </div>
        <div class="card-face card-back">
            <div id="trigger-flip-back" style="position:absolute; left:0; top:20%; width:40px; height:60%; cursor:pointer; z-index:100;" onclick="toggleFlip()"></div>
            <div class="info-label" style="margin-bottom:15px;">FOCUS HEATMAP (LAST 100 DAYS)</div>
            <div id="heatmap" class="heatmap-grid"></div>
            <div class="info-label" style="margin-top: 20px; font-size: 0.9rem;">* CLICK TEXT BELOW TO CHANGE KEYWORD</div>
        </div>
    </div>
</div>
<div id="quote-container" onclick="setFocusKeyword()"><div id="quote-content" class="quote-text">Syncing...</div></div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    const SB_URL = "https://rattzrovuipztscogenj.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJhdHR6cm92dWlwenRzY29nZW5qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNjEyNTgsImV4cCI6MjA4NTkzNzI1OH0.zfMIL_hnFzTXnUG_HdN-NtjJWbmrvmpdJy-OeCiqiOI";
    const YT_API_KEY = "AIzaSyCRqth-MrjfAjhDsdTPP-CPw-xn93oJWAY"; 
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let totalSeconds = 0, todaySeconds = 0, historyData = {}, isDayMode = localStorage.getItem('px_mode') !== 'night', isRunning = false, timerInterval;
    let focusKeyword = localStorage.getItem('focus_keyword') || "study with me";
    let lastQuoteText = "", isFlipping = false, sessionSeconds = 0; 

    const getTodayKey = () => new Date().toISOString().split('T')[0];

    async function getLiveLearnersCount() {
        try {
            const searchUrl = `https://www.googleapis.com/youtube/v3/search?part=snippet&eventType=live&type=video&q=${encodeURIComponent(focusKeyword)}&maxResults=5&key=${YT_API_KEY}`;
            const res = await fetch(searchUrl);
            const data = await res.json();
            if (!data.items || data.items.length === 0) return null;
            const videoIds = data.items.map(i => i.id.videoId).join(',');
            const statsRes = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=liveStreamingDetails&id=${videoIds}&key=${YT_API_KEY}`);
            const statsData = await statsRes.json();
            let total = 0;
            statsData.items?.forEach(i => { total += parseInt(i.liveStreamingDetails?.concurrentViewers || 0); });
            return total > 0 ? total : null;
        } catch (e) { return null; }
    }

    async function updateQuote(force = false) {
        const c = document.getElementById('quote-content');
        if (force || lastQuoteText === "") {
            const count = await getLiveLearnersCount();
            lastQuoteText = count ? `${count.toLocaleString()} souls are in the ${focusKeyword} flow.` : `Keep pushing in your ${focusKeyword} journey.`;
        }
        c.innerText = lastQuoteText;
        c.style.color = 'var(--text-secondary)';
        c.style.opacity = 1;
    }

    function toggleFlip() {
        if (isFlipping) return;
        isFlipping = true;
        const card = document.getElementById('card-root');
        card.classList.toggle('is-flipped');
        setTimeout(() => { if(card.classList.contains('is-flipped')) initHeatmap(); updateQuote(); isFlipping = false; }, 650);
    }

    function showTip(text) {
        if (document.getElementById('card-root').classList.contains('is-flipped')) return;
        const c = document.getElementById('quote-content');
        c.innerText = text; c.style.color = 'var(--text-primary)';
    }

    function hideTip() { 
        const c = document.getElementById('quote-content');
        c.innerText = lastQuoteText; c.style.color = 'var(--text-secondary)';
    }

    function setFocusKeyword() {
        let input = prompt("What are you focusing on?", focusKeyword);
        if (input !== null && input.trim() !== "") { focusKeyword = input.trim(); localStorage.setItem('focus_keyword', focusKeyword); updateQuote(true); }
    }

    function initHeatmap() {
        const h = document.getElementById('heatmap'); h.innerHTML = '';
        const now = new Date();
        for (let i = 99; i >= 0; i--) {
            const d = new Date(); d.setDate(now.getDate() - i);
            const key = d.toISOString().split('T')[0];
            const hrs = (historyData[key] || 0) / 3600;
            const cell = document.createElement('div');
            cell.className = 'heat-cell';
            if (hrs > 0) cell.style.background = `rgba(${isDayMode?'34,139,34':'51,255,51'}, ${Math.min(0.2+hrs/5, 1)})`;
            h.appendChild(cell);
        }
    }

    function updateUI(shouldSync = true) {
        document.getElementById('total-time').innerText = formatTime(totalSeconds);
        document.getElementById('today-time').innerText = formatTime(todaySeconds).substring(5);
        const dayOfYear = Math.floor((new Date() - new Date(new Date().getFullYear(), 0, 0)) / 86400000);
        document.getElementById('year-stats').innerText = `${dayOfYear}/365 DAYS (${(dayOfYear/3.65).toFixed(2)}%)`;
        document.getElementById('year-bar').style.width = (dayOfYear/3.65) + '%';
        historyData[getTodayKey()] = todaySeconds;
        if (shouldSync) syncToCloud();
    }

    function formatTime(s) { 
        const h=Math.floor(s/3600), m=Math.floor((s%3600)/60), sc=s%60;
        return `${h.toString().padStart(4,'0')}:${m.toString().padStart(2,'0')}:${sc.toString().padStart(2,'0')}`;
    }

    function editTotal() { let v=prompt("Total Hours:", (totalSeconds/3600).toFixed(2)); if(v){totalSeconds=parseFloat(v)*3600; updateUI();} }
    function editToday() { let v=prompt("Today Hours:", (todaySeconds/3600).toFixed(2)); if(v){todaySeconds=parseFloat(v)*3600; updateUI();} }

    const setupEdit = (id, fn) => {
        const el = document.getElementById(id);
        el.addEventListener('click', (e) => { if(window.innerWidth > 768) fn(); });
        el.addEventListener('dblclick', (e) => { if(window.innerWidth <= 768) fn(); });
    };
    setupEdit('box-total', editTotal);
    setupEdit('box-today', editToday);

    document.getElementById('start-btn').onclick = () => { 
        if(!isRunning){ 
            isRunning=true; 
            sessionSeconds = 0; 
            timerInterval=setInterval(()=>{
                totalSeconds++; todaySeconds++; sessionSeconds++; 
                updateUI(false);
            },1000); 
        }
    };

    document.getElementById('pause-btn').onclick = () => { 
        if(isRunning){
            isRunning=false; 
            clearInterval(timerInterval);
            
            // 烟花分级算法 (秒数)
            let level = 0;
            if (sessionSeconds >= 7200) level = 4; // > 120min
            else if (sessionSeconds >= 3600) level = 3; // > 60min
            else if (sessionSeconds >= 2100) level = 2; // > 35min
            else if (sessionSeconds >= 900) level = 1;  // > 15min

            if (level > 0) launchCelebration(window.innerWidth/2, window.innerHeight/2, level);
            
            sessionSeconds = 0; 
            syncToCloud(); 
        }
    };

    document.getElementById('reset-btn').onclick = () => { if(confirm("Reset?")){ totalSeconds=0; todaySeconds=0; sessionSeconds=0; updateUI(); }};
    document.getElementById('celestial-body').onclick = () => { isDayMode=!isDayMode; renderTheme(); };

    async function syncToCloud() { await _supabase.from('records').upsert({ id: 1, data: { totalSeconds, todaySeconds, historyData }}); }
    async function loadFromCloud() { 
        const { data } = await _supabase.from('records').select('data').eq('id', 1).single();
        if (data?.data) { totalSeconds = data.data.totalSeconds || 0; todaySeconds = data.data.todaySeconds || 0; historyData = data.data.historyData || {}; updateUI(false); } 
    }

    function renderTheme() {
        document.body.className = isDayMode ? 'day-mode' : '';
        document.getElementById('celestial-body').innerHTML = isDayMode ? sunIcon : moonIcon;
        localStorage.setItem('px_mode', isDayMode ? 'day' : 'night');
        updateFavicon();
    }

    function updateFavicon() {
        const svg = isDayMode ? sunIcon : moonIcon;
        const canvasFav = document.createElement('canvas');
        canvasFav.width = 32; canvasFav.height = 32;
        const ctxFav = canvasFav.getContext('2d');
        const img = new Image();
        img.onload = () => { ctxFav.drawImage(img, 0, 0, 32, 32); document.getElementById('dynamic-favicon').href = canvasFav.toDataURL('image/png'); };
        img.src = 'data:image/svg+xml;base64,' + btoa(svg);
    }

    const sunIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect x="5" y="1" width="6" height="14" fill="#FFD700"/><rect x="3" y="2" width="10" height="12" fill="#FFD700"/><rect x="2" y="3" width="12" height="10" fill="#FFD700"/><rect x="1" y="5" width="14" height="6" fill="#FFD700"/></svg>`;
    const moonIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><rect x="5" y="1" width="6" height="14" fill="#E0E0E0"/><rect x="3" y="2" width="10" height="12" fill="#E0E0E0"/><rect x="2" y="3" width="12" height="10" fill="#E0E0E0"/><rect x="1" y="5" width="14" height="6" fill="#E0E0E0"/><circle cx="5" cy="6" r="1.5" fill="#BDBDBD"/><circle cx="11" cy="5" r="1.2" fill="#BDBDBD"/><circle cx="8" cy="11" r="1.8" fill="#BDBDBD"/></svg>`;

    (async () => { renderTheme(); await loadFromCloud(); updateQuote(true); setInterval(() => updateQuote(true), 60000); })();

    const canvas = document.getElementById('fireworks-canvas'), ctx = canvas.getContext('2d');
    let particles = [];
    window.addEventListener('resize', () => { canvas.width = window.innerWidth; canvas.height = window.innerHeight; });
    window.dispatchEvent(new Event('resize'));
    function animate() { ctx.clearRect(0,0,canvas.width,canvas.height); particles = particles.filter(p => p.alpha > 0); particles.forEach(p => { p.update(); p.draw(); }); requestAnimationFrame(animate); }
    animate();

    class Particle { 
        constructor(x, y, color, speed) { 
            this.x = x; this.y = y; this.color = color; 
            this.vx = (Math.random()-0.5)*speed; this.vy = (Math.random()-0.5)*speed; 
            this.alpha = 1; 
        } 
        update() { this.x += this.vx; this.y += this.vy; this.vy += 0.15; this.alpha -= 0.01; } 
        draw() { ctx.globalAlpha = this.alpha; ctx.fillStyle = this.color; ctx.fillRect(this.x, this.y, 3, 3); } 
    }
    
    function launchCelebration(x, y, level = 1) { 
        const colors = isDayMode ? ['#228b22', '#ff4500', '#ffd700', '#1e90ff'] : ['#33ff33', '#ffffff', '#ffeb3b', '#ff4081']; 
        
        let count, speed, waves, scatter;
        
        switch(level) {
            case 1: count=50; speed=8; waves=1; scatter=80; break;      // 15-35: 小型
            case 2: count=100; speed=12; waves=2; scatter=150; break;   // 35-60: 中型
            case 3: count=150; speed=18; waves=3; scatter=250; break;   // 60-120: 大型
            case 4: count=250; speed=25; waves=5; scatter=500; break;   // >120: 全屏霸屏
        }

        for(let j=0; j<waves; j++) {
            setTimeout(() => {
                for(let i=0; i<count; i++) {
                    const spawnX = level === 4 ? Math.random() * canvas.width : x + (Math.random()-0.5)*scatter;
                    const spawnY = level === 4 ? Math.random() * canvas.height : y + (Math.random()-0.5)*scatter;
                    particles.push(new Particle(spawnX, spawnY, colors[Math.floor(Math.random()*colors.length)], speed));
                }
            }, j * 250);
        }
    }
</script>
</body>
</html>
